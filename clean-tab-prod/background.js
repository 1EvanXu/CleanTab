(()=>{"use strict";var e={750:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function a(e){try{c(i.next(e))}catch(e){o(e)}}function s(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.DuplicatedTabHandler=void 0;const r=n(306),o=n(469),a=n(239),s=n(685),c=n(386);class l extends c.TabCleanTask{constructor(e){super(),this.url=e,this.tabIds=new Array,this.tabId=-1}add(e){this.tabIds.indexOf(e)<0&&(this.tabIds.push(e),this.reserved||(this.reserved=e))}getDuplicatedTabIds(){return this.tabIds.filter((e=>e!=this.reserved))}count(){return this.tabIds.length}}!function(e){let t=new Array;function n(){return i(this,void 0,void 0,(function*(){return(yield o.TabInfoProxy.getAll()).forEach((e=>{if(!e.url||!a.UrlUtils.isHttpUrl(e.url))return;let n=t.find((t=>e.url==t.url&&!t.cleaned));e.id&&(n?e.discarded||(n.reserved=e.id):(n=new l(e.url),n.title=e.title,n.tabId=-1,n.favicon=e.favIconUrl,t.push(n)),n.add(e.id))})),t=t.filter((e=>e.count()>1)),t}))}e.observeFutureUrl=function(e,t){return i(this,void 0,void 0,(function*(){if(!a.UrlUtils.isChromeUrl(t)&&function(e){const t=s.SettingsManager.getSettings();if("auto"!=t.cleanMode)return!1;if(t.disableGlobal)return!1;const n=a.UrlUtils.getHostName(e);return!(n&&t.disabledDomainList.indexOf(n)>-1)}(t)){const n=yield o.TabInfoProxy.getByUrl(t),i=null==n?void 0:n.filter((t=>t.id!=e));i&&i.length>0&&i[0].id&&(o.TabOperationProxy.remove(e),o.TabOperationProxy.active(i[0].id)),r.FutureTabManager.remove(e)}}))},e.getDuplicatedTabs=n,e.cleanDuplicatedTabs=function(e){return i(this,void 0,void 0,(function*(){(yield n()).filter((t=>e.indexOf(t.taskId)>-1&&!t.cleaned)).forEach((e=>{try{o.TabOperationProxy.batchRemove(...e.getDuplicatedTabIds()),e.cleaned=!0}catch(e){a.CTLog.warn(e)}}))}))}}(t.DuplicatedTabHandler||(t.DuplicatedTabHandler={}))},839:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.BGLogRemoteClient=t.BGLogRemoteServer=t.BGLogger=void 0;const n="BGLog";class i{constructor(){this.level="debug"}}class r{constructor(){this.action=n}}class o{constructor(){this.TAG="BGLog",this.level="debug",this.logger={debug:console.debug,info:console.info,warn:console.warn,error:console.error}}setTag(e){this.TAG=e}setLevel(e){this.level=e}setPrinter(e=console.debug,t=console.info,n=console.warn,i=console.error){this.logger.debug=e,this.logger.info=t,this.logger.warn=n,this.logger.error=i}debug(...e){"debug"==this.level&&this.logger.debug(this.TAG,"[debug]",...e)}info(...e){"debug"!=this.level&&"info"!=this.level||this.logger.info(this.TAG,"[info]",...e)}warn(...e){"debug"!=this.level&&"info"!=this.level&&"warn"!=this.level||this.logger.warn(this.TAG,"[warn]",...e)}error(...e){this.logger.error(this.TAG,"[error]",...e)}}t.BGLogger=o,function(e){let t;const i=e=>{if(t&&e.action==n&&e.payload){const{tag:n,level:i,content:r}=e.payload;switch(n&&t.setTag(n),i){case"debug":t.debug(r);break;case"info":t.info(r);break;case"warn":t.warn(r);break;case"error":t.error(r)}}};e.start=function(){t=new o,t.info("[BGLogRemoteServer] start runing ðŸš€ðŸš€ðŸš€ðŸš€ðŸš€ðŸš€"),chrome.runtime.onMessage.hasListener(i)&&chrome.runtime.onMessage.removeListener(i),chrome.runtime.onMessage.addListener(i)},e.stop=function(){chrome.runtime.onMessage.removeListener(i),t=void 0}}(t.BGLogRemoteServer||(t.BGLogRemoteServer={})),function(e){let t=!0;function n(e,n){const o=new r,a=new i;t&&(a.tag="BGLogRemoteClient",t=!1),a.content=n,a.level=e,o.payload=a,chrome.runtime.sendMessage(o)}e.debug=function(...e){n("debug",e)},e.info=function(...e){n("info",e)},e.warn=function(...e){n("warn",e)},e.error=function(...e){n("error",e)}}(t.BGLogRemoteClient||(t.BGLogRemoteClient={}))},386:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.TabCleanTask=void 0;let n=0;t.TabCleanTask=class{constructor(){this.tabId=0,this.cleaned=!1,n++,this._taskId=n}get taskId(){return this._taskId}newObject(){return{taskId:this.taskId,favicon:this.favicon,title:this.title,url:this.url,count:this.count(),cleand:this.cleaned}}}},239:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.StringUtils=t.UrlUtils=t.CTLog=void 0;const i=n(839);var r,o;!function(e){function t(e){if(e)try{return new URL(e).hostname}catch(e){a.warn("UrlUtils.getHostName",JSON.stringify(e))}}function n(e){return!(!(null==e?void 0:e.startsWith("https"))&&!(null==e?void 0:e.startsWith("http")))}e.compareUrl=function(e,t){if(!e||!t)return!1;const n=new URL(e),i=new URL(t);if(n.hostname!=i.hostname)return!1;if(n.pathname!=i.pathname)return!1;const r=new URLSearchParams(n.searchParams),o=new URLSearchParams(i.searchParams);if(r.keys.length!=o.keys.length)return!1;for(const e in r)if(r.get(e)!=o.get(e))return!1;return n.hash==i.hash},e.getHostName=t,e.isHttpUrl=n,e.isChromeUrl=function(e){return!!(null==e?void 0:e.startsWith("chrome"))},e.getDomain=function(e){let i="";if(n(e)&&(e=t(e)),e){const t=e.split(".");t.length>=2?(t.pop(),"www"==t[0]&&t.shift(),i=t.join(".")):i=e}return i}}(r||(r={})),t.UrlUtils=r,function(e){function t(e){return null==e||0==e.length}e.isEmpty=t,e.isNotEmpty=function(e){return!t(e)}}(o||(o={})),t.StringUtils=o;const a=new i.BGLogger;t.CTLog=a,a.setTag("CleanTab")},685:function(e,t){var n=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function a(e){try{c(i.next(e))}catch(e){o(e)}}function s(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.SettingsManager=void 0,function(e){const t="cleanTabSettings",i=chrome.storage.local;class r{constructor(){this.cleanMode="auto",this.disableGlobal=!1,this.disableNotification=!1,this.disabledDomainList=[]}}let o,a=!1;function s(){return n(this,void 0,void 0,(function*(){a||(chrome.storage.onChanged.addListener(((e,n)=>{for(let[i,{newValue:r}]of Object.entries(e))"local"==n&&i==t&&(o=r)})),function(){n(this,void 0,void 0,(function*(){const e=yield i.get(t);0===Object.keys(e).length?(o=new r,i.set({cleanTabSettings:o})):o=e.cleanTabSettings}))}())}))}e.init=s,e.getSettings=function(){return a||s(),o},e.updateSettings=function(e){if(e.domainDisabled)"string"==typeof e.domainDisabled&&-1==o.disabledDomainList.indexOf(e.domainDisabled)&&o.disabledDomainList.push(e.domainDisabled);else if(e.domainEnabled){if("string"==typeof e.domainEnabled&&o.disabledDomainList.indexOf(e.domainEnabled)>-1){const t=o.disabledDomainList.indexOf(e.domainEnabled);o.disabledDomainList.splice(t,1)}}else Object.assign(o,e);i.set({cleanTabSettings:o})}}(t.SettingsManager||(t.SettingsManager={}))},306:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.FutureTabManager=t.FutureTab=void 0;const i=n(386),r=n(239);class o extends i.TabCleanTask{constructor(e,t){super(),this.tabId=e,this.observer=t}setUrl(e){!this.url&&e&&r.StringUtils.isNotEmpty(e)&&(this.url=e,this.observer&&this.title&&this.favicon&&this.observer(this.tabId,this.url))}setTitle(e){!this.title&&e&&r.StringUtils.isNotEmpty(e)&&(this.title=e,this.observer&&this.url&&this.favicon&&this.observer(this.tabId,this.url))}setFavicon(e){!this.favicon&&e&&r.StringUtils.isNotEmpty(e)&&(this.favicon=e,this.observer&&this.url&&this.title&&this.observer(this.tabId,this.url))}count(){return 2}}t.FutureTab=o,function(e){const t=[];function n(e){return t.find((t=>t.tabId==e&&!t.cleaned))}e.add=function(e){n(e.tabId)||t.push(e)},e.get=n,e.remove=function(e){const t=n(e);t&&(t.cleaned=!0)},e.getAllCleaned=function(){return t.filter((e=>e.cleaned))}}(t.FutureTabManager||(t.FutureTabManager={}))},597:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.TabEventsDispatcher=t.TabEventsHandler=void 0;class n{handleCreated(e){return!0}handleActivated(e){return!0}handleAttatched(e,t){return!0}handleDetatched(e,t){return!0}handleHighlighted(e){return!0}handleMoved(e,t){return!0}handleRemoved(e,t){return!0}handleReplaced(e,t){return!0}handleUpdated(e,t,n){return!0}handleZoomChange(e){return!0}}t.TabEventsHandler=n,function(e){let t=!1,i=new Array;e.init=function(){t||(chrome.tabs.onCreated.addListener((e=>{!function(e){for(const t of i)if(!t.handleCreated(e))break}(e)})),chrome.tabs.onActivated.addListener((e=>{!function(e){for(const t of i)if(!t.handleActivated(e))break}(e)})),chrome.tabs.onAttached.addListener(((e,t)=>{!function(e,t){for(const n of i)if(!n.handleAttatched(e,t))break}(e,t)})),chrome.tabs.onDetached.addListener(((e,t)=>{!function(e,t){for(const n of i)if(!n.handleDetatched(e,t))break}(e,t)})),chrome.tabs.onMoved.addListener(((e,t)=>{!function(e,t){for(const n of i)if(!n.handleMoved(e,t))break}(e,t)})),chrome.tabs.onRemoved.addListener(((e,t)=>{!function(e,t){for(const n of i)if(!n.handleRemoved(e,t))break}(e,t)})),chrome.tabs.onUpdated.addListener(((e,t,n)=>{!function(e,t,n){for(const r of i)if(!r.handleUpdated(e,t,n))break}(e,t,n)})),chrome.tabs.onReplaced.addListener(((e,t)=>{!function(e,t){for(const n of i)if(!n.handleReplaced(e,t))break}(e,t)})),chrome.tabs.onHighlighted.addListener((e=>{!function(e){for(const t of i)if(!t.handleHighlighted(e))break}(e)})),chrome.tabs.onZoomChange.addListener((e=>{!function(e){for(const t of i)if(!t.handleZoomChange(e))break}(e)})),t=!0)},e.register=function(e){e instanceof n&&i.push(e)},e.unregister=function(e){i=i.filter((t=>t!=e))}}(t.TabEventsDispatcher||(t.TabEventsDispatcher={}))},469:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function a(e){try{c(i.next(e))}catch(e){o(e)}}function s(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.TabOperationProxy=t.TabInfoProxy=void 0;const r=n(239);var o,a;!function(e){function t(){return chrome.tabs.query({})}e.getAll=t,e.getHighlighted=function(){return i(this,void 0,void 0,(function*(){const[e]=yield chrome.tabs.query({highlighted:!0});return e}))},e.getByUrl=function(e){return i(this,void 0,void 0,(function*(){return(yield t()).filter((t=>r.UrlUtils.compareUrl(t.url,e)))}))},e.getByGroupId=function(e){return chrome.tabs.query({groupId:e})}}(o||(o={})),t.TabInfoProxy=o,function(e){const t=chrome.tabs;function n(e){t.remove(e)}e.active=function(e){t.update(e,{active:!0})},e.move=function(e,n){t.move(e,{index:n})},e.remove=n,e.batchRemove=function(...e){e.forEach((e=>n(e)))},e.group=function(e){return t.group(e)}}(a||(a={})),t.TabOperationProxy=a}},t={};function n(i){var r=t[i];if(void 0!==r)return r.exports;var o=t[i]={exports:{}};return e[i].call(o.exports,o,o.exports,n),o.exports}(()=>{const e=n(750),t=n(685),i=n(306),r=n(597),o=n(469),a=n(239),s=n(839);chrome.runtime.onInstalled.addListener((e=>(e=>{a.CTLog.info("Installed success.",e),s.BGLogRemoteServer.start()})(e))),chrome.runtime.onMessage.addListener(((e,t,n)=>{"logToBackground"==e.action?a.CTLog.warn("Popup => ",e.payload):(a.CTLog.debug("OnMessage","msg=",e,"sender=",t,"sendResponse=",n),c(e,n))})),chrome.runtime.onConnect.addListener((e=>{a.CTLog.debug("new connetion established => ",e),"CleanTabService"==e.name&&e.onMessage.addListener(((e,t)=>{if(a.CTLog.debug("connection received message => ",t,e),"ACK"==e.action){const n={};Object.assign(n,e),t.postMessage(n)}else c(e,(n=>{const i={action:e.action,payload:n,requestId:e.requestId};t.postMessage(i)}))})),e.onDisconnect.addListener((e=>{a.CTLog.warn("Connection destroyed => ",e)}))}));const c=(n,r)=>{if("getDuplicatedTabs"==n.action)e.DuplicatedTabHandler.getDuplicatedTabs().then((e=>{let n;n="auto"==t.SettingsManager.getSettings().cleanMode?i.FutureTabManager.getAllCleaned().map((e=>e.newObject())):e.map((e=>e.newObject())),r(n)}));else if("getSettingsInfo"==n.action){const e=t.SettingsManager.getSettings();r(e)}else"updateSettings"==n.action?n.payload&&t.SettingsManager.updateSettings(n.payload):"getCurrentDoaminDisabled"==n.action?o.TabInfoProxy.getHighlighted().then((e=>{if(a.UrlUtils.isHttpUrl(e.url)){const n=a.UrlUtils.getHostName(e.url);let i=!1;n&&(i=t.SettingsManager.getSettings().disabledDomainList.indexOf(n)>-1),r({currentDomain:n,disabled:i})}})):"performCleanTask"==n.action&&n.payload&&n.payload.taskIdList&&e.DuplicatedTabHandler.cleanDuplicatedTabs(n.payload.taskIdList)};class l extends r.TabEventsHandler{handleUpdated(e,t,n){const r=i.FutureTabManager.get(e);return a.CTLog.debug("futureTab",r),r&&(r.setUrl(t.url),r.setFavicon(t.favIconUrl),r.setTitle(t.title)),!0}handleCreated(t){return t.id&&i.FutureTabManager.add(new i.FutureTab(t.id,e.DuplicatedTabHandler.observeFutureUrl)),!0}}const d=new l;r.TabEventsDispatcher.init(),r.TabEventsDispatcher.register(d),t.SettingsManager.init()})()})();