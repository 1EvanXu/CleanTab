(()=>{"use strict";var e={750:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.DuplicatedTabHandler=void 0;const o=n(306),i=n(469),a=n(239),s=n(685);class c{constructor(e){this.url=e,this.tabIds=new Array}add(e){this.tabIds.indexOf(e)<0&&(this.tabIds.push(e),this.reserved||(this.reserved=e))}getDuplicatedTabIds(){return this.tabIds.filter((e=>e!=this.reserved))}count(){return this.tabIds.length}}!function(e){function t(){return r(this,void 0,void 0,(function*(){const e=new Map,t=new Array;return(yield i.TabInfoProxy.getAll()).forEach((t=>{if(!t.url||!a.UrlUtils.isHttpUrl(t.url))return;e.has(t.url)||e.set(t.url,new c(t.url));const n=e.get(t.url);n&&t.id&&(n.add(t.id),t.discarded||(n.reserved=t.id))})),e.forEach((e=>{e.count()>1&&t.push(e)})),t}))}e.observeFutureUrl=function(e,t){return r(this,void 0,void 0,(function*(){if(!a.UrlUtils.isChromeUrl(t)&&function(e){const t=s.SettingsManager.getSettings();if("auto"!=t.cleanMode)return!1;if(t.disableGlobal)return!1;const n=a.UrlUtils.getHostName(e);return!(n&&t.disabledDomainList.indexOf(n)>-1)}(t)){const n=yield i.TabInfoProxy.getByUrl(t),r=null==n?void 0:n.filter((t=>t.id!=e));r&&r.length>0&&setTimeout((()=>{r[0].id&&(i.TabOperationProxy.remove(e),i.TabOperationProxy.active(r[0].id))}),1e3),o.FutureTabManager.remove(e)}}))},e.getDuplicatedTabs=t,e.cleanDuplicatedTabs=function(){return r(this,void 0,void 0,(function*(){(yield t()).forEach((e=>{try{i.TabOperationProxy.batchRemove(...e.getDuplicatedTabIds())}catch(e){a.CTLog.error(e)}}))}))}}(t.DuplicatedTabHandler||(t.DuplicatedTabHandler={}))},839:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.BGLogRemoteClient=t.BGLogRemoteServer=t.BGLogger=void 0;const n="BGLog";class r{constructor(){this.level="debug"}}class o{constructor(){this.action=n}}class i{constructor(){this.TAG="BGLog",this.level="debug",this.logger={debug:console.debug,info:console.info,warn:console.warn,error:console.error}}setTag(e){this.TAG=e}setLevel(e){this.level=e}setPrinter(e=console.debug,t=console.info,n=console.warn,r=console.error){this.logger.debug=e,this.logger.info=t,this.logger.warn=n,this.logger.error=r}debug(...e){"debug"==this.level&&this.logger.debug(this.TAG,"[debug]",...e)}info(...e){"debug"!=this.level&&"info"!=this.level||this.logger.info(this.TAG,"[info]",...e)}warn(...e){"debug"!=this.level&&"info"!=this.level&&"warn"!=this.level||this.logger.warn(this.TAG,"[warn]",...e)}error(...e){this.logger.error(this.TAG,"[error]",...e)}}t.BGLogger=i,function(e){let t;const r=e=>{if(t&&e.action==n&&e.payload){const{tag:n,level:r,content:o}=e.payload;switch(n&&t.setTag(n),r){case"debug":t.debug(o);break;case"info":t.info(o);break;case"warn":t.warn(o);break;case"error":t.error(o)}}};e.start=function(){t=new i,t.info("[BGLogRemoteServer] start runing ðŸš€ðŸš€ðŸš€ðŸš€ðŸš€ðŸš€"),chrome.runtime.onMessage.hasListener(r)&&chrome.runtime.onMessage.removeListener(r),chrome.runtime.onMessage.addListener(r)},e.stop=function(){chrome.runtime.onMessage.removeListener(r),t=void 0}}(t.BGLogRemoteServer||(t.BGLogRemoteServer={})),function(e){let t=!0;function n(e,n){const i=new o,a=new r;t&&(a.tag="BGLogRemoteClient",t=!1),a.content=n,a.level=e,i.payload=a,chrome.runtime.sendMessage(i)}e.debug=function(...e){n("debug",e)},e.info=function(...e){n("info",e)},e.warn=function(...e){n("warn",e)},e.error=function(...e){n("error",e)}}(t.BGLogRemoteClient||(t.BGLogRemoteClient={}))},239:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.StringUtils=t.UrlUtils=t.CTLog=void 0;const r=n(839);var o,i;!function(e){function t(e){if(e)try{return new URL(e).hostname}catch(e){a.warn("UrlUtils.getHostName",JSON.stringify(e))}}function n(e){return!(!(null==e?void 0:e.startsWith("https"))&&!(null==e?void 0:e.startsWith("http")))}e.compareUrl=function(e,t){if(!e||!t)return!1;const n=new URL(e),r=new URL(t);if(n.hostname!=r.hostname)return!1;if(n.pathname!=r.pathname)return!1;const o=new URLSearchParams(n.searchParams),i=new URLSearchParams(r.searchParams);if(o.keys.length!=i.keys.length)return!1;for(const e in o)if(o.get(e)!=i.get(e))return!1;return!0},e.getHostName=t,e.isHttpUrl=n,e.isChromeUrl=function(e){return!!(null==e?void 0:e.startsWith("chrome"))},e.getDomain=function(e){let r="";if(n(e)&&(e=t(e)),e){const t=e.split(".");t.length>=2?(t.pop(),"www"==t[0]&&t.shift(),r=t.join(".")):r=e}return r}}(o||(o={})),t.UrlUtils=o,function(e){function t(e){return null==e||0==e.length}e.isEmpty=t,e.isNotEmpty=function(e){return!t(e)}}(i||(i={})),t.StringUtils=i;const a=new r.BGLogger;t.CTLog=a,a.setTag("CleanTab")},685:function(e,t){var n=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.SettingsManager=void 0,function(e){const t="cleanTabSettings",r=chrome.storage.local;class o{constructor(){this.cleanMode="auto",this.disableGlobal=!1,this.disableNotification=!1,this.disabledDomainList=[]}}let i,a=!1;function s(){return n(this,void 0,void 0,(function*(){a||(chrome.storage.onChanged.addListener(((e,n)=>{for(let[r,{newValue:o}]of Object.entries(e))"local"==n&&r==t&&(i=o)})),function(){n(this,void 0,void 0,(function*(){const e=yield r.get(t);0===Object.keys(e).length?(i=new o,r.set({cleanTabSettings:i})):i=e.cleanTabSettings}))}())}))}e.init=s,e.getSettings=function(){return a||s(),i},e.updateSettings=function(e){if(e.domainDisabled)"string"==typeof e.domainDisabled&&-1==i.disabledDomainList.indexOf(e.domainDisabled)&&i.disabledDomainList.push(e.domainDisabled);else if(e.domainEnabled){if("string"==typeof e.domainEnabled&&i.disabledDomainList.indexOf(e.domainEnabled)>-1){const t=i.disabledDomainList.indexOf(e.domainEnabled);i.disabledDomainList.splice(t,1)}}else Object.assign(i,e);r.set({cleanTabSettings:i})}}(t.SettingsManager||(t.SettingsManager={}))},306:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.FutureTabManager=t.FutureTab=void 0,t.FutureTab=class{constructor(e,t){this.tabId=e,this.observer=t}setUrl(e){this.url||(this.url=e,this.observer&&this.observer(this.tabId,e))}},function(e){const t=[];function n(e){return t.find((t=>t.tabId===e))}e.add=function(e){n(e.tabId)||t.push(e)},e.get=n,e.remove=function(e){}}(t.FutureTabManager||(t.FutureTabManager={}))},597:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.TabEventsDispatcher=t.TabEventsHandler=void 0;class n{handleCreated(e){return!0}handleActivated(e){return!0}handleAttatched(e,t){return!0}handleDetatched(e,t){return!0}handleHighlighted(e){return!0}handleMoved(e,t){return!0}handleRemoved(e,t){return!0}handleReplaced(e,t){return!0}handleUpdated(e,t,n){return!0}handleZoomChange(e){return!0}}t.TabEventsHandler=n,function(e){let t=!1,r=new Array;e.init=function(){t||(chrome.tabs.onCreated.addListener((e=>{!function(e){for(const t of r)if(!t.handleCreated(e))break}(e)})),chrome.tabs.onActivated.addListener((e=>{!function(e){for(const t of r)if(!t.handleActivated(e))break}(e)})),chrome.tabs.onAttached.addListener(((e,t)=>{!function(e,t){for(const n of r)if(!n.handleAttatched(e,t))break}(e,t)})),chrome.tabs.onDetached.addListener(((e,t)=>{!function(e,t){for(const n of r)if(!n.handleDetatched(e,t))break}(e,t)})),chrome.tabs.onMoved.addListener(((e,t)=>{!function(e,t){for(const n of r)if(!n.handleMoved(e,t))break}(e,t)})),chrome.tabs.onRemoved.addListener(((e,t)=>{!function(e,t){for(const n of r)if(!n.handleRemoved(e,t))break}(e,t)})),chrome.tabs.onUpdated.addListener(((e,t,n)=>{!function(e,t,n){for(const o of r)if(!o.handleUpdated(e,t,n))break}(e,t,n)})),chrome.tabs.onReplaced.addListener(((e,t)=>{!function(e,t){for(const n of r)if(!n.handleReplaced(e,t))break}(e,t)})),chrome.tabs.onHighlighted.addListener((e=>{!function(e){for(const t of r)if(!t.handleHighlighted(e))break}(e)})),chrome.tabs.onZoomChange.addListener((e=>{!function(e){for(const t of r)if(!t.handleZoomChange(e))break}(e)})),t=!0)},e.register=function(e){e instanceof n&&r.push(e)},e.unregister=function(e){r=r.filter((t=>t!=e))}}(t.TabEventsDispatcher||(t.TabEventsDispatcher={}))},469:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.TabOperationProxy=t.TabInfoProxy=void 0;const o=n(239);var i,a;!function(e){function t(){return chrome.tabs.query({})}e.getAll=t,e.getHighlighted=function(){return r(this,void 0,void 0,(function*(){const[e]=yield chrome.tabs.query({highlighted:!0});return e}))},e.getByUrl=function(e){return r(this,void 0,void 0,(function*(){return(yield t()).filter((t=>o.UrlUtils.compareUrl(t.url,e)))}))},e.getByGroupId=function(e){return chrome.tabs.query({groupId:e})}}(i||(i={})),t.TabInfoProxy=i,function(e){const t=chrome.tabs;function n(e){t.remove(e)}e.active=function(e){t.update(e,{active:!0})},e.move=function(e,n){t.move(e,{index:n})},e.remove=n,e.batchRemove=function(...e){e.forEach((e=>n(e)))},e.group=function(e){return t.group(e)}}(a||(a={})),t.TabOperationProxy=a}},t={};function n(r){var o=t[r];if(void 0!==o)return o.exports;var i=t[r]={exports:{}};return e[r].call(i.exports,i,i.exports,n),i.exports}(()=>{const e=n(750),t=n(685),r=n(306),o=n(597),i=n(469),a=n(239),s=n(839);chrome.runtime.onInstalled.addListener((e=>(e=>{a.CTLog.info("Installed success.",e),s.BGLogRemoteServer.start()})(e))),chrome.runtime.onMessage.addListener(((e,t,n)=>{"logToBackground"==e.action?a.CTLog.warn("Popup => ",e.payload):(a.CTLog.debug("OnMessage","msg=",e,"sender=",t,"sendResponse=",n),c(e,n))})),chrome.runtime.onConnect.addListener((e=>{a.CTLog.debug("new connetion established => ",e),"CleanTabService"==e.name&&e.onMessage.addListener(((e,t)=>{if(a.CTLog.debug("connection received message => ",t,e),"ACK"==e.action){const n={};Object.assign(n,e),t.postMessage(n)}else c(e,(n=>{const r={action:e.action,payload:n,requestId:e.requestId};t.postMessage(r)}))})),e.onDisconnect.addListener((e=>{a.CTLog.warn("Connection destroyed => ",e)}))}));const c=(n,r)=>{if("getDuplicatedTabs"==n.action)e.DuplicatedTabHandler.getDuplicatedTabs().then((e=>{const t=e.map((e=>({taskId:e.reserved,url:e.url,count:e.count(),cleand:!1})));a.CTLog.warn(t),r(t)}));else if("getSettingsInfo"==n.action){const e=t.SettingsManager.getSettings();r(e)}else"updateSettings"==n.action?n.payload&&t.SettingsManager.updateSettings(n.payload):"getCurrentDoaminDisabled"==n.action&&i.TabInfoProxy.getHighlighted().then((e=>{if(a.UrlUtils.isHttpUrl(e.url)){const n=a.UrlUtils.getHostName(e.url);let o=!1;n&&(o=t.SettingsManager.getSettings().disabledDomainList.indexOf(n)>-1),r({currentDomain:n,disabled:o})}}))};class d extends o.TabEventsHandler{handleUpdated(e,t,n){const o=r.FutureTabManager.get(e);return o&&t.url&&a.StringUtils.isNotEmpty(t.url)&&o.setUrl(t.url),!0}handleCreated(t){return t.id&&r.FutureTabManager.add(new r.FutureTab(t.id,e.DuplicatedTabHandler.observeFutureUrl)),!0}}const u=new d;o.TabEventsDispatcher.init(),o.TabEventsDispatcher.register(u),t.SettingsManager.init()})()})();